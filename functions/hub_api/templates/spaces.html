{% extends "base.html" %}

{% block title %}Spaces - Marvain{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1 class="page-title"><i class="fas fa-layer-group"></i> Spaces</h1>
    <p class="text-muted">Virtual rooms where conversations and activities happen</p>
  </div>
  <div class="page-actions">
    <button type="button" class="btn btn-primary" onclick="Marvain.showCreateSpaceModal()">
      <i class="fas fa-plus"></i> Create Space
    </button>
  </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar mb-lg">
  <div class="filter-group">
    <label for="agent-filter">Agent</label>
    <select id="agent-filter" onchange="filterSpaces()">
      <option value="">All Agents</option>
      {% for agent in agents %}
      <option value="{{ agent.agent_id }}">{{ agent.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="filter-group">
    <label for="privacy-filter">Privacy Mode</label>
    <select id="privacy-filter" onchange="filterSpaces()">
      <option value="">All</option>
      <option value="true">Privacy On</option>
      <option value="false">Privacy Off</option>
    </select>
  </div>
  <div class="filter-group flex-grow">
    <label for="search-filter">Search</label>
    <input type="text" id="search-filter" placeholder="Search spaces..." oninput="filterSpaces()">
  </div>
</div>

<!-- Spaces Grid -->
<div class="grid grid-3" id="spaces-grid">
  {% if spaces %}
  {% for space in spaces %}
  <div class="space-card card" data-agent="{{ space.agent_id }}" data-privacy="{{ space.privacy_mode|lower }}" data-name="{{ space.name|lower }}">
    <div class="card-body">
      <div class="space-header">
        <div class="space-icon">
          <i class="fas fa-comments"></i>
        </div>
        <div class="space-info">
          <h4 class="space-name">{{ space.name }}</h4>
          <span class="text-muted">{{ space.agent_name }}</span>
        </div>
        {% if space.privacy_mode %}
        <span class="badge badge-warning" title="Privacy mode enabled">
          <i class="fas fa-lock"></i> Private
        </span>
        {% endif %}
      </div>
      <div class="space-details">
        <div class="detail-row">
          <span class="detail-label">Space ID</span>
          <code class="detail-value">{{ space.space_id[:8] }}...</code>
        </div>
        <div class="detail-row">
          <span class="detail-label">Created</span>
          <span class="detail-value">{{ space.created_at_relative or 'N/A' }}</span>
        </div>
      </div>
      <div class="space-actions">
        <a href="/livekit-test?space={{ space.space_id }}" class="btn btn-sm btn-primary">
          <i class="fas fa-video"></i> Join
        </a>
        <button class="btn btn-sm btn-outline" onclick="editSpace('{{ space.space_id }}', '{{ space.name | replace("'", "\\'") }}')">
          <i class="fas fa-cog"></i>
        </button>
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
  <div class="empty-state" style="grid-column: 1 / -1;">
    <i class="fas fa-layer-group fa-3x"></i>
    <h3>No Spaces Found</h3>
    <p>Create your first space to start conversations.</p>
    <button type="button" class="btn btn-primary" onclick="Marvain.showCreateSpaceModal()">
      <i class="fas fa-plus"></i> Create Space
    </button>
  </div>
  {% endif %}
</div>

<!-- Create Space Modal -->
<div id="create-space-modal" class="modal" style="display: none;">
  <div class="modal-backdrop" onclick="Marvain.hideModal('create-space-modal')"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>Create New Space</h3>
      <button type="button" class="btn btn-sm" onclick="Marvain.hideModal('create-space-modal')">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form onsubmit="submitCreateSpace(event)">
      <div class="modal-body">
        <div class="form-group">
          <label for="space-agent">Agent *</label>
          <select id="space-agent" name="agent_id" required>
            {% for agent in agents %}
            {% if agent.role in ['owner', 'admin'] %}
            <option value="{{ agent.agent_id }}">{{ agent.name }}</option>
            {% endif %}
            {% endfor %}
          </select>
          <small class="text-muted">Select which agent owns this space</small>
        </div>
        <div class="form-group">
          <label for="space-name">Space Name *</label>
          <input type="text" id="space-name" name="name" required placeholder="Living Room">
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="space-privacy" name="privacy_mode">
            <span>Enable Privacy Mode</span>
          </label>
          <small class="text-muted">When enabled, the planner will not save memories from this space</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" onclick="Marvain.hideModal('create-space-modal')">
          Cancel
        </button>
        <button type="submit" class="btn btn-primary">Create Space</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Space Modal -->
<div id="edit-space-modal" class="modal" style="display: none;">
  <div class="modal-backdrop" onclick="Marvain.hideModal('edit-space-modal')"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>Edit Space</h3>
      <button type="button" class="btn btn-sm" onclick="Marvain.hideModal('edit-space-modal')">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form onsubmit="submitEditSpace(event)">
      <div class="modal-body">
        <input type="hidden" id="edit-space-id">
        <div class="form-group">
          <label for="edit-space-name">Space Name *</label>
          <input type="text" id="edit-space-name" name="name" required placeholder="My Space">
        </div>
        <div class="form-group">
          <label class="checkbox-label">
            <input type="checkbox" id="edit-space-privacy" name="privacy_mode">
            <span>Privacy Mode</span>
          </label>
          <small class="form-help">When enabled, no recordings or transcripts will be stored</small>
        </div>
        <hr style="border-color: var(--color-gray-600); margin: 1.5rem 0;">
        <div class="danger-zone" style="border: 1px solid var(--color-error); border-radius: var(--radius-md); padding: 1rem; background: rgba(239, 68, 68, 0.1);">
          <h4 style="color: var(--color-error); margin: 0 0 0.5rem 0;"><i class="fas fa-exclamation-triangle"></i> Danger Zone</h4>
          <p class="text-muted" style="margin-bottom: 1rem;">Deleting a space cannot be undone. All conversation history in this space will be lost.</p>
          <button type="button" class="btn" style="background: var(--color-error); color: white;" onclick="confirmDeleteSpace()">
            <i class="fas fa-trash"></i> Delete Space
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" onclick="Marvain.hideModal('edit-space-modal')">Cancel</button>
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> Save Changes
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterSpaces() {
  const agent = document.getElementById('agent-filter').value;
  const privacy = document.getElementById('privacy-filter').value;
  const search = document.getElementById('search-filter').value.toLowerCase();

  document.querySelectorAll('.space-card').forEach(card => {
    const matchAgent = !agent || card.dataset.agent === agent;
    const matchPrivacy = !privacy || card.dataset.privacy === privacy;
    const matchSearch = !search || card.dataset.name.includes(search);
    card.style.display = matchAgent && matchPrivacy && matchSearch ? '' : 'none';
  });
}

// Track current space being edited
let currentEditSpaceId = null;
let currentEditSpaceName = null;

async function editSpace(spaceId, spaceName) {
  currentEditSpaceId = spaceId;
  currentEditSpaceName = spaceName;

  try {
    Marvain.showLoading('Loading space details...');
    const response = await fetch(`/api/spaces/${spaceId}`);
    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.detail || 'Failed to load space');
    }
    const space = await response.json();
    Marvain.hideLoading();

    document.getElementById('edit-space-id').value = space.space_id;
    document.getElementById('edit-space-name').value = space.name;
    document.getElementById('edit-space-privacy').checked = space.privacy_mode || false;
    Marvain.showModal('edit-space-modal');
  } catch (error) {
    Marvain.hideLoading();
    Marvain.showToast('error', 'Error', error.message);
  }
}

async function submitEditSpace(event) {
  event.preventDefault();
  const spaceId = document.getElementById('edit-space-id').value;
  const name = document.getElementById('edit-space-name').value.trim();
  const privacyMode = document.getElementById('edit-space-privacy').checked;

  if (!name) {
    Marvain.showToast('error', 'Error', 'Space name is required');
    return;
  }

  try {
    Marvain.showLoading('Saving changes...');
    const response = await fetch(`/api/spaces/${spaceId}`, {
      method: 'PATCH',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({name: name, privacy_mode: privacyMode})
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.detail || 'Failed to update space');
    }

    Marvain.hideLoading();
    Marvain.hideModal('edit-space-modal');
    Marvain.showToast('success', 'Success', 'Space updated successfully');
    setTimeout(() => location.reload(), 1000);
  } catch (error) {
    Marvain.hideLoading();
    Marvain.showToast('error', 'Error', error.message);
  }
}

function confirmDeleteSpace() {
  if (!currentEditSpaceId) return;

  if (!confirm(`Are you sure you want to delete "${currentEditSpaceName}"? This action cannot be undone.`)) {
    return;
  }

  deleteSpace(currentEditSpaceId);
}

async function deleteSpace(spaceId) {
  try {
    Marvain.showLoading('Deleting space...');
    const response = await fetch(`/api/spaces/${spaceId}`, {
      method: 'DELETE',
      headers: {'Content-Type': 'application/json'}
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.detail || 'Failed to delete space');
    }

    Marvain.hideLoading();
    Marvain.hideModal('edit-space-modal');
    Marvain.showToast('success', 'Deleted', 'Space deleted successfully');
    setTimeout(() => location.reload(), 1000);
  } catch (error) {
    Marvain.hideLoading();
    Marvain.showToast('error', 'Error', error.message);
  }
}

async function submitCreateSpace(event) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);

  const data = {
    agent_id: formData.get('agent_id'),
    name: formData.get('name'),
    privacy_mode: formData.get('privacy_mode') === 'on'
  };

  try {
    Marvain.showLoading('Creating space...');
    const response = await fetch('/api/spaces', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.detail || 'Failed to create space');
    }

    Marvain.hideLoading();
    Marvain.hideModal('create-space-modal');
    Marvain.showToast('success', 'Success', 'Space created successfully');
    setTimeout(() => location.reload(), 1000);
  } catch (error) {
    Marvain.hideLoading();
    Marvain.showToast('error', 'Error', error.message);
  }
}

// Register modal show function
Marvain.showCreateSpaceModal = function() {
  Marvain.showModal('create-space-modal');
};
</script>
{% endblock %}
