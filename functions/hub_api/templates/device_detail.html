{% extends "base.html" %}

{% block title %}{{ device.name }} - Device Details{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <nav class="breadcrumb">
      <a href="/devices"><i class="fas fa-microchip"></i> Devices</a>
      <span class="separator">/</span>
      <span>{{ device.name }}</span>
    </nav>
    <h1 class="page-title">{{ device.name }}</h1>
  </div>
  <div class="page-actions">
    {% if not device.revoked %}
    <button type="button" class="btn btn-primary" id="ping-btn" onclick="pingDevice('{{ device.device_id }}')">
      <i class="fas fa-wifi"></i> Ping Device
    </button>
    <button type="button" class="btn btn-outline btn-danger" onclick="revokeDevice('{{ device.device_id }}')">
      <i class="fas fa-ban"></i> Revoke Device
    </button>
    {% endif %}
    <button type="button" class="btn btn-outline btn-danger" onclick="deleteDevice('{{ device.device_id }}', '{{ device.name }}')">
      <i class="fas fa-trash"></i> Delete Device
    </button>
  </div>
</div>

<!-- Device Info Card -->
<div class="grid grid-2">
  <div class="card">
    <div class="card-header">
      <h3 class="card-title"><i class="fas fa-info-circle"></i> Device Information</h3>
    </div>
    <div class="card-body">
      <div class="info-grid">
        <div class="info-row">
          <span class="info-label">Device ID</span>
          <span class="info-value">
            <code>{{ device.device_id }}</code>
            <button type="button" class="btn btn-sm btn-outline" onclick="copyText('{{ device.device_id }}', 'Device ID')">
              <i class="fas fa-copy"></i>
            </button>
          </span>
        </div>
        <div class="info-row">
          <span class="info-label">Name</span>
          <span class="info-value">{{ device.name }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Agent</span>
          <span class="info-value">
            <a href="/agents/{{ device.agent_id }}">{{ device.agent_name }}</a>
          </span>
        </div>
        <div class="info-row">
          <span class="info-label">Status</span>
          <span class="info-value">
            {% if device.revoked %}
            <span class="badge badge-error"><i class="fas fa-ban"></i> Revoked</span>
            {% elif device.is_online %}
            <span class="badge badge-success"><i class="fas fa-circle"></i> Online</span>
            {% else %}
            <span class="badge badge-warning"><i class="fas fa-circle"></i> Offline</span>
            {% endif %}
          </span>
        </div>
        <div class="info-row">
          <span class="info-label">Created</span>
          <span class="info-value">{{ device.created_at }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Last Seen</span>
          <span class="info-value">{{ device.last_seen or 'Never' }}</span>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-header">
      <h3 class="card-title"><i class="fas fa-shield-alt"></i> Permissions (Scopes)</h3>
    </div>
    <div class="card-body">
      {% if device.scopes %}
      <div class="scope-list">
        {% for scope in device.scopes %}
        <span class="badge badge-info">{{ scope }}</span>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-muted">No scopes assigned</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- Connection Info -->
<div class="card mt-lg">
  <div class="card-header">
    <h3 class="card-title"><i class="fas fa-plug"></i> Connection</h3>
  </div>
  <div class="card-body">
    {% if device.revoked %}
    <div class="alert alert-error">
      <i class="fas fa-ban"></i> This device has been revoked and can no longer connect.
    </div>
    {% else %}
    <p class="text-muted mb-md">To connect this device to the hub, run the remote satellite daemon:</p>
    <div class="form-group">
      <label>Connection Command</label>
      <div class="input-group">
        <textarea class="form-control" readonly id="connect-command" rows="2"
                  style="font-family: monospace; font-size: 0.85rem; resize: none;">python apps/remote_satellite/daemon.py --hub-ws-url {{ ws_url or 'wss://YOUR_WS_URL' }} --device-token YOUR_DEVICE_TOKEN</textarea>
        <button type="button" class="btn btn-outline" onclick="copyText(document.getElementById('connect-command').value, 'Command')">
          <i class="fas fa-copy"></i> Copy
        </button>
      </div>
      <small class="text-muted">Note: You need the device token from when the device was registered. Tokens are only shown once.</small>
    </div>

    <details style="margin-top: var(--spacing-lg);">
      <summary style="cursor: pointer; color: var(--color-highlight); font-weight: 500; padding: var(--spacing-sm) 0;">
        <i class="fas fa-book-open"></i> Getting Started — Full Setup Guide
      </summary>
      <div style="margin-top: var(--spacing-md); padding: var(--spacing-md); background: var(--color-gray-700); border-radius: var(--radius-md);">
        <h4 style="margin-bottom: var(--spacing-sm);">1. Prerequisites</h4>
        <ul style="margin-left: var(--spacing-lg); margin-bottom: var(--spacing-md); color: var(--color-gray-300);">
          <li>Python 3.11+ with the <code>marvain</code> conda environment activated</li>
          <li>The device token (shown once at registration — copy it then)</li>
          <li>Network access to the Hub WebSocket endpoint</li>
        </ul>

        <h4 style="margin-bottom: var(--spacing-sm);">2. Activate Environment</h4>
        <pre style="background: var(--color-gray-900); padding: var(--spacing-sm); border-radius: var(--radius-sm); font-size: 0.85rem; overflow-x: auto; margin-bottom: var(--spacing-md);"><code>cd /path/to/marvain
source marvain_activate</code></pre>

        <h4 style="margin-bottom: var(--spacing-sm);">3. Run the Satellite Daemon</h4>
        <pre style="background: var(--color-gray-900); padding: var(--spacing-sm); border-radius: var(--radius-sm); font-size: 0.85rem; overflow-x: auto; margin-bottom: var(--spacing-md);"><code>python apps/remote_satellite/daemon.py \
  --hub-ws-url {{ ws_url or 'wss://YOUR_WS_URL' }} \
  --device-token YOUR_DEVICE_TOKEN</code></pre>

        <h4 style="margin-bottom: var(--spacing-sm);">4. Verify</h4>
        <p style="color: var(--color-gray-300); margin-bottom: var(--spacing-md);">Once the daemon connects, this device's status will change to <span class="badge badge-success" style="font-size: 0.75rem;"><i class="fas fa-circle"></i> Online</span> and the <strong>Ping Device</strong> button above will receive a response.</p>

        <h4 style="margin-bottom: var(--spacing-sm);">5. Next Steps — Using Your Device</h4>
        <p style="color: var(--color-gray-300); margin-bottom: var(--spacing-sm);">
          Devices are satellite nodes in the Marvain agent hub. Once online, a device can:
        </p>
        <ul style="margin-left: var(--spacing-lg); margin-bottom: var(--spacing-md); color: var(--color-gray-300);">
          <li><strong>Receive commands</strong> — The hub sends real-time instructions via WebSocket (e.g., play audio, capture data)</li>
          <li><strong>Emit events</strong> — The daemon pushes events (sensor data, voice transcripts, presence changes) back to the hub</li>
          <li><strong>Execute actions</strong> — Approved actions on the <a href="/actions" style="color: var(--color-highlight);">Actions</a> page can target this device</li>
        </ul>
        <p style="color: var(--color-gray-300); margin-bottom: var(--spacing-sm);"><strong>Explore further:</strong></p>
        <ul style="margin-left: var(--spacing-lg); color: var(--color-gray-300);">
          <li><a href="/events" style="color: var(--color-highlight);"><i class="fas fa-bolt"></i> Events</a> — View events emitted by this device</li>
          <li><a href="/actions" style="color: var(--color-highlight);"><i class="fas fa-cogs"></i> Actions</a> — Create actions that target this device</li>
          <li><a href="/memories" style="color: var(--color-highlight);"><i class="fas fa-brain"></i> Memories</a> — Browse memories derived from device interactions</li>
          <li><a href="/livekit-test" style="color: var(--color-highlight);"><i class="fas fa-microphone"></i> LiveKit Test</a> — Test voice interaction with the agent</li>
        </ul>
      </div>
    </details>
    {% endif %}
  </div>
</div>

<!-- Agent Worker Controls -->
{% if not device.revoked %}
<div class="card mt-lg">
  <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
    <h3 class="card-title"><i class="fas fa-robot"></i> Agent Worker</h3>
    <div id="aw-status-badge">
      <span class="badge" style="background: var(--color-gray-600);"><i class="fas fa-spinner fa-spin"></i> Checking…</span>
    </div>
  </div>
  <div class="card-body">
    <div class="info-grid" id="aw-info" style="margin-bottom: var(--spacing-md);">
      <div class="info-row">
        <span class="info-label">Status</span>
        <span class="info-value" id="aw-status-text">—</span>
      </div>
      <div class="info-row">
        <span class="info-label">PID</span>
        <span class="info-value" id="aw-pid-text">—</span>
      </div>
      <div class="info-row">
        <span class="info-label">Log File</span>
        <span class="info-value" id="aw-log-text" style="word-break: break-all;">—</span>
      </div>
    </div>
    <div style="display: flex; gap: var(--spacing-sm); flex-wrap: wrap;">
      <button type="button" class="btn btn-primary" id="aw-launch-btn" onclick="awLaunch()" style="display:none;">
        <i class="fas fa-play"></i> Launch Agent Worker
      </button>
      <button type="button" class="btn btn-outline" id="aw-restart-btn" onclick="awRestart()" style="display:none;">
        <i class="fas fa-sync-alt"></i> Restart
      </button>
      <button type="button" class="btn btn-outline btn-danger" id="aw-stop-btn" onclick="awStop()" style="display:none;">
        <i class="fas fa-stop"></i> Stop
      </button>
      <button type="button" class="btn btn-outline" id="aw-refresh-btn" onclick="awRefreshStatus()">
        <i class="fas fa-redo"></i> Refresh
      </button>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
function copyText(text, label) {
  navigator.clipboard.writeText(text).then(() => {
    Marvain.showToast('success', 'Copied', label + ' copied to clipboard');
  }).catch(() => {
    Marvain.showToast('error', 'Error', 'Failed to copy to clipboard');
  });
}

function pingDevice(deviceId) {
  const pingBtn = document.getElementById('ping-btn');
  if (pingBtn) {
    pingBtn.disabled = true;
    pingBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Pinging...';
  }

  // Check if WebSocket is connected and authenticated
  if (!Marvain.ws || Marvain.ws.readyState !== WebSocket.OPEN) {
    Marvain.showToast('error', 'Not Connected', 'WebSocket not connected. Please refresh the page.');
    if (pingBtn) {
      pingBtn.disabled = false;
      pingBtn.innerHTML = '<i class="fas fa-wifi"></i> Ping Device';
    }
    return;
  }

  if (!Marvain.wsAuthenticated) {
    Marvain.showToast('warning', 'Authenticating', 'Please wait for WebSocket authentication...');
    if (pingBtn) {
      pingBtn.disabled = false;
      pingBtn.innerHTML = '<i class="fas fa-wifi"></i> Ping Device';
    }
    return;
  }

  // Set up one-time listener for ping response
  const pingHandler = function(msg) {
    if (msg.type === 'cmd.ping' && msg.target_device_id === deviceId) {
      Marvain.wsOff('message', pingHandler);
      if (pingBtn) {
        pingBtn.disabled = false;
        pingBtn.innerHTML = '<i class="fas fa-wifi"></i> Ping Device';
      }
      if (msg.ok) {
        if (msg.device_online) {
          Marvain.showToast('success', 'Device Online',
            `Device responded! Sent to ${msg.device_connections} connection(s).`);
          // Update status badge
          const statusBadge = document.querySelector('.info-value .badge');
          if (statusBadge) {
            statusBadge.className = 'badge badge-success';
            statusBadge.innerHTML = '<i class="fas fa-circle"></i> Online';
          }
        } else {
          Marvain.showToast('warning', 'Device Offline', 'Device is not connected to the hub.');
        }
      } else {
        Marvain.showToast('error', 'Ping Failed', msg.error || 'Unknown error');
      }
    }
  };
  Marvain.wsOn('message', pingHandler);

  // Send ping command
  Marvain.wsSend({
    action: 'cmd.ping',
    target_device_id: deviceId
  });

  // Timeout after 10 seconds
  setTimeout(() => {
    Marvain.wsOff('message', pingHandler);
    if (pingBtn && pingBtn.disabled) {
      pingBtn.disabled = false;
      pingBtn.innerHTML = '<i class="fas fa-wifi"></i> Ping Device';
      Marvain.showToast('warning', 'Timeout', 'No response from hub');
    }
  }, 10000);
}

async function revokeDevice(deviceId) {
  if (!confirm('Are you sure you want to revoke this device? This action cannot be undone.')) {
    return;
  }

  try {
    Marvain.showLoading('Revoking device...');
    const response = await fetch(`/api/devices/${deviceId}/revoke`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.detail || 'Failed to revoke device');
    }

    Marvain.hideLoading();
    Marvain.showToast('success', 'Success', 'Device revoked successfully');
    setTimeout(() => location.reload(), 1000);
  } catch (error) {
    Marvain.hideLoading();
    Marvain.showToast('error', 'Error', error.message);
  }
}

async function deleteDevice(deviceId, deviceName) {
  if (!confirm(`Are you sure you want to PERMANENTLY DELETE the device "${deviceName}"?\n\nThis will remove all records of this device. This action cannot be undone.`)) {
    return;
  }

  // Double confirmation for destructive action
  if (!confirm('This is a permanent deletion. Are you absolutely sure?')) {
    return;
  }

  try {
    Marvain.showLoading('Deleting device...');
    const response = await fetch(`/api/devices/${deviceId}/delete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.detail || 'Failed to delete device');
    }

    Marvain.hideLoading();
    Marvain.showToast('success', 'Deleted', 'Device permanently deleted');
    // Redirect to devices list since this device no longer exists
    setTimeout(() => window.location.href = '/devices', 1000);
  } catch (error) {
    Marvain.hideLoading();
    Marvain.showToast('error', 'Error', error.message);
  }
}

// --- Agent Worker lifecycle controls ---
function _awUpdateUI(data) {
  const running = data.status === 'running' || data.status === 'already_running';
  const badge = document.getElementById('aw-status-badge');
  const statusText = document.getElementById('aw-status-text');
  const pidText = document.getElementById('aw-pid-text');
  const logText = document.getElementById('aw-log-text');
  const launchBtn = document.getElementById('aw-launch-btn');
  const stopBtn = document.getElementById('aw-stop-btn');
  const restartBtn = document.getElementById('aw-restart-btn');

  if (running) {
    badge.innerHTML = '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Running</span>';
    statusText.textContent = 'Running';
    pidText.textContent = data.pid || '—';
    launchBtn.style.display = 'none';
    stopBtn.style.display = '';
    restartBtn.style.display = '';
  } else {
    badge.innerHTML = '<span class="badge badge-warning"><i class="fas fa-circle"></i> Stopped</span>';
    statusText.textContent = 'Stopped';
    pidText.textContent = '—';
    launchBtn.style.display = '';
    stopBtn.style.display = 'none';
    restartBtn.style.display = 'none';
  }
  logText.textContent = data.log_file || '—';
}

async function awRefreshStatus() {
  try {
    const resp = await fetch('/api/agent-worker/status');
    if (!resp.ok) throw new Error('Failed to get status');
    const data = await resp.json();
    _awUpdateUI(data);
  } catch (e) {
    document.getElementById('aw-status-badge').innerHTML =
      '<span class="badge badge-error"><i class="fas fa-times-circle"></i> Error</span>';
  }
}

async function awLaunch() {
  const btn = document.getElementById('aw-launch-btn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Launching…';
  try {
    const resp = await fetch('/api/agent-worker/launch', { method: 'POST' });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.detail || 'Launch failed');
    Marvain.showToast('success', 'Agent Worker', data.message);
    _awUpdateUI(data);
  } catch (e) {
    Marvain.showToast('error', 'Launch Failed', e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-play"></i> Launch Agent Worker';
  }
}

async function awStop() {
  const btn = document.getElementById('aw-stop-btn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Stopping…';
  try {
    const resp = await fetch('/api/agent-worker/stop', { method: 'POST' });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.detail || 'Stop failed');
    Marvain.showToast('success', 'Agent Worker', data.message);
    _awUpdateUI(data);
  } catch (e) {
    Marvain.showToast('error', 'Stop Failed', e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-stop"></i> Stop';
  }
}

async function awRestart() {
  const btn = document.getElementById('aw-restart-btn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Restarting…';
  try {
    const resp = await fetch('/api/agent-worker/restart', { method: 'POST' });
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.detail || 'Restart failed');
    Marvain.showToast('success', 'Agent Worker', data.message);
    _awUpdateUI(data);
  } catch (e) {
    Marvain.showToast('error', 'Restart Failed', e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-sync-alt"></i> Restart';
  }
}

// Auto-fetch status on page load
document.addEventListener('DOMContentLoaded', awRefreshStatus);
</script>

<style>
.info-grid {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}
.info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0.5rem 0;
  border-bottom: 1px solid var(--color-gray-700);
}
.info-row:last-child {
  border-bottom: none;
}
.info-label {
  color: var(--color-gray-400);
  font-weight: 500;
}
.info-value {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.info-value code {
  font-size: 0.85rem;
  background: var(--color-gray-700);
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
}
.scope-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}
.breadcrumb {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 0.5rem;
  font-size: 0.9rem;
}
.breadcrumb a {
  color: var(--color-gray-400);
  text-decoration: none;
}
.breadcrumb a:hover {
  color: var(--color-highlight);
}
.breadcrumb .separator {
  color: var(--color-gray-500);
}
.mt-lg {
  margin-top: 1.5rem;
}
.mb-md {
  margin-bottom: 1rem;
}
</style>
{% endblock %}

