{% extends "base.html" %}

{% block title %}Devices - Marvain{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1 class="page-title"><i class="fas fa-microchip"></i> Devices</h1>
    <p class="text-muted">Registered devices with access to your agents</p>
  </div>
  <div class="page-actions">
    <button type="button" class="btn btn-primary" onclick="Marvain.showCreateDeviceModal()">
      <i class="fas fa-plus"></i> Register Device
    </button>
  </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar mb-lg">
  <div class="filter-group">
    <label for="agent-filter">Agent</label>
    <select id="agent-filter" onchange="filterDevices()">
      <option value="">All Agents</option>
      {% for agent in agents %}
      <option value="{{ agent.agent_id }}">{{ agent.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="filter-group">
    <label for="status-filter">Status</label>
    <select id="status-filter" onchange="filterDevices()">
      <option value="">All</option>
      <option value="active">Active</option>
      <option value="revoked">Revoked</option>
    </select>
  </div>
  <div class="filter-group flex-grow">
    <label for="search-filter">Search</label>
    <input type="text" id="search-filter" placeholder="Search devices..." oninput="filterDevices()">
  </div>
</div>

<!-- Devices Grid -->
<div class="grid grid-3" id="devices-grid">
  {% if devices %}
  {% for device in devices %}
  <div class="device-card card" data-agent="{{ device.agent_id }}" data-status="{{ 'revoked' if device.revoked else 'active' }}" data-name="{{ device.name|lower }}">
    <div class="card-body">
      <div class="device-header">
        <div class="device-icon {{ 'revoked' if device.revoked else '' }}">
          <i class="fas fa-microchip"></i>
        </div>
        <div class="device-info">
          <h4 class="device-name">{{ device.name or 'Unnamed Device' }}</h4>
          <span class="text-muted">{{ device.agent_name }}</span>
        </div>
        {% if device.revoked %}
        <span class="badge badge-error">Revoked</span>
        {% else %}
        <span class="badge badge-success">Active</span>
        {% endif %}
      </div>
      <div class="device-details">
        <div class="detail-row">
          <span class="detail-label">Device ID</span>
          <code class="detail-value">{{ device.device_id[:8] }}...</code>
        </div>
        <div class="detail-row">
          <span class="detail-label">Last Seen</span>
          <span class="detail-value">{{ device.last_seen_relative or 'Never' }}</span>
        </div>
        <div class="detail-row">
          <span class="detail-label">Scopes</span>
          <span class="detail-value">{{ device.scopes|length }} assigned</span>
        </div>
      </div>
      <div class="device-scopes">
        {% for scope in device.scopes[:3] %}
        <span class="scope-badge">{{ scope }}</span>
        {% endfor %}
        {% if device.scopes|length > 3 %}
        <span class="scope-badge more">+{{ device.scopes|length - 3 }}</span>
        {% endif %}
      </div>
      <div class="device-actions">
        <button class="btn btn-sm btn-outline" onclick="viewDevice('{{ device.device_id }}')">
          <i class="fas fa-eye"></i> View
        </button>
        {% if not device.revoked %}
        <button class="btn btn-sm btn-outline btn-danger" onclick="revokeDevice('{{ device.device_id }}')">
          <i class="fas fa-ban"></i> Revoke
        </button>
        {% endif %}
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
  <div class="empty-state" style="grid-column: 1 / -1;">
    <i class="fas fa-microchip fa-3x"></i>
    <h3>No Devices Registered</h3>
    <p>Register a device to allow programmatic access to your agents.</p>
    <button type="button" class="btn btn-primary" onclick="Marvain.showCreateDeviceModal()">
      <i class="fas fa-plus"></i> Register Device
    </button>
  </div>
  {% endif %}
</div>

<!-- Register Device Modal -->
<div id="create-device-modal" class="modal" style="display: none;">
  <div class="modal-backdrop" onclick="Marvain.hideModal('create-device-modal')"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>Register New Device</h3>
      <button type="button" class="btn btn-sm" onclick="Marvain.hideModal('create-device-modal')">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <form onsubmit="submitCreateDevice(event)">
      <div class="modal-body">
        <div class="form-group">
          <label for="device-agent">Agent *</label>
          <select id="device-agent" name="agent_id" required>
            {% for agent in agents %}
            {% if agent.role in ['owner', 'admin'] %}
            <option value="{{ agent.agent_id }}">{{ agent.name }}</option>
            {% endif %}
            {% endfor %}
          </select>
        </div>
        <div class="form-group">
          <label for="device-name">Device Name *</label>
          <input type="text" id="device-name" name="name" required placeholder="Kitchen Speaker">
        </div>
        <div class="form-group">
          <label>Scopes</label>
          <div class="scopes-checklist">
            <label class="checkbox-label"><input type="checkbox" name="scopes" value="events:read"> events:read</label>
            <label class="checkbox-label"><input type="checkbox" name="scopes" value="events:write"> events:write</label>
            <label class="checkbox-label"><input type="checkbox" name="scopes" value="presence:write"> presence:write</label>
            <label class="checkbox-label"><input type="checkbox" name="scopes" value="memories:read"> memories:read</label>
          </div>
          <small class="text-muted">Select which permissions this device will have</small>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" onclick="Marvain.hideModal('create-device-modal')">Cancel</button>
        <button type="submit" class="btn btn-primary">Register Device</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterDevices() {
  const agent = document.getElementById('agent-filter').value;
  const status = document.getElementById('status-filter').value;
  const search = document.getElementById('search-filter').value.toLowerCase();

  document.querySelectorAll('.device-card').forEach(card => {
    const matchAgent = !agent || card.dataset.agent === agent;
    const matchStatus = !status || card.dataset.status === status;
    const matchSearch = !search || card.dataset.name.includes(search);
    card.style.display = matchAgent && matchStatus && matchSearch ? '' : 'none';
  });
}

function viewDevice(deviceId) {
  Marvain.showToast('info', 'Coming Soon', 'Device details will be available in a future update.');
}

async function revokeDevice(deviceId) {
  if (!confirm('Are you sure you want to revoke this device? This action cannot be undone.')) {
    return;
  }

  try {
    Marvain.showLoading('Revoking device...');
    const response = await fetch(`/api/devices/${deviceId}/revoke`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.detail || 'Failed to revoke device');
    }

    Marvain.hideLoading();
    Marvain.showToast('success', 'Success', 'Device revoked successfully');
    setTimeout(() => location.reload(), 1000);
  } catch (error) {
    Marvain.hideLoading();
    Marvain.showToast('error', 'Error', error.message);
  }
}

async function submitCreateDevice(event) {
  event.preventDefault();
  const form = event.target;
  const formData = new FormData(form);

  const scopes = [];
  form.querySelectorAll('input[name="scopes"]:checked').forEach(cb => {
    scopes.push(cb.value);
  });

  const data = {
    agent_id: formData.get('agent_id'),
    name: formData.get('name'),
    scopes: scopes
  };

  try {
    Marvain.showLoading('Registering device...');
    const response = await fetch('/api/devices', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(data)
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.detail || 'Failed to register device');
    }

    const result = await response.json();
    Marvain.hideLoading();
    Marvain.hideModal('create-device-modal');

    // Show token in alert (user should copy it - it won't be shown again)
    alert('Device registered successfully!\n\nDevice Token (copy this, it will not be shown again):\n' + result.token);
    location.reload();
  } catch (error) {
    Marvain.hideLoading();
    Marvain.showToast('error', 'Error', error.message);
  }
}

// Register modal show function
Marvain.showCreateDeviceModal = function() {
  Marvain.showModal('create-device-modal');
};
</script>
{% endblock %}

