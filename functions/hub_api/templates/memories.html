{% extends "base.html" %}

{% block title %}Memories - Marvain{% endblock %}

{% block head %}
<style>
.detail-section { margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--color-gray-600); }
.detail-section:last-child { border-bottom: none; margin-bottom: 0; }
.detail-section h4 { margin: 0 0 1rem 0; color: var(--color-gray-200); font-size: 1rem; }
.detail-section h4 i { margin-right: 0.5rem; color: var(--color-highlight); }
.detail-grid { display: grid; gap: 0.75rem; }
.detail-row { display: flex; align-items: center; gap: 1rem; }
.detail-label { color: var(--color-gray-400); min-width: 120px; font-size: 0.875rem; }
.detail-value { color: var(--color-gray-200); }
.json-display { background: var(--color-gray-900); padding: 1rem; border-radius: var(--radius-md); overflow-x: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.8125rem; color: var(--color-gray-200); max-height: 300px; overflow-y: auto; margin: 0; white-space: pre-wrap; word-wrap: break-word; }
.loading-spinner { text-align: center; padding: 2rem; color: var(--color-gray-400); }
.error-message { text-align: center; padding: 2rem; color: var(--color-error); }
.participant-list { display: flex; flex-wrap: wrap; gap: 0.5rem; }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1 class="page-title"><i class="fas fa-brain"></i> Memories</h1>
    <p class="text-muted">Browse and manage agent memories</p>
  </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar mb-lg">
  <div class="filter-group">
    <label for="agent-filter">Agent</label>
    <select id="agent-filter" onchange="filterMemories()">
      <option value="">All Agents</option>
      {% for agent in agents %}
      <option value="{{ agent.agent_id }}">{{ agent.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="filter-group">
    <label for="tier-filter">Tier</label>
    <select id="tier-filter" onchange="filterMemories()">
      <option value="">All Tiers</option>
      <option value="episodic">Episodic</option>
      <option value="semantic">Semantic</option>
      <option value="procedural">Procedural</option>
    </select>
  </div>
  <div class="filter-group">
    <label for="space-filter">Space</label>
    <select id="space-filter" onchange="filterMemories()">
      <option value="">All Spaces</option>
      {% for space in spaces %}
      <option value="{{ space.space_id }}">{{ space.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="filter-group flex-grow">
    <label for="search-filter">Search</label>
    <input type="text" id="search-filter" placeholder="Search memories..." oninput="filterMemories()">
  </div>
</div>

<!-- Stats Bar -->
<div class="stats-bar mb-lg">
  <div class="stat-item">
    <span class="stat-label">Total</span>
    <span class="stat-value">{{ memories|length }}</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">Episodic</span>
    <span class="stat-value tier-episodic">{{ tier_counts.episodic or 0 }}</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">Semantic</span>
    <span class="stat-value tier-semantic">{{ tier_counts.semantic or 0 }}</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">Procedural</span>
    <span class="stat-value tier-procedural">{{ tier_counts.procedural or 0 }}</span>
  </div>
</div>

<!-- Memories List -->
<div class="memories-list" id="memories-list">
  {% if memories %}
  {% for memory in memories %}
  <div class="memory-card card" data-agent="{{ memory.agent_id }}" data-tier="{{ memory.tier }}" data-space="{{ memory.space_id or '' }}" data-content="{{ memory.content|lower }}">
    <div class="card-body">
      <div class="memory-header">
        <div class="memory-meta">
          <span class="tier-badge tier-{{ memory.tier }}">{{ memory.tier }}</span>
          <span class="text-muted">{{ memory.agent_name }}</span>
          {% if memory.space_name %}
          <span class="text-muted">â€¢ {{ memory.space_name }}</span>
          {% endif %}
        </div>
        <div class="memory-time">{{ memory.created_at_relative or 'Unknown' }}</div>
      </div>
      <div class="memory-content">
        {{ memory.content[:500] }}{% if memory.content|length > 500 %}...{% endif %}
      </div>
      {% if memory.participants %}
      <div class="memory-participants">
        <i class="fas fa-users"></i>
        {% for p in memory.participants[:3] %}
        <span class="participant-badge">{{ p }}</span>
        {% endfor %}
        {% if memory.participants|length > 3 %}
        <span class="participant-badge more">+{{ memory.participants|length - 3 }}</span>
        {% endif %}
      </div>
      {% endif %}
      <div class="memory-footer">
        <div class="memory-provenance">
          {% if memory.provenance_source %}
          <span class="provenance-badge" title="{{ memory.provenance_source }}">
            <i class="fas fa-history"></i> {{ memory.provenance_source[:20] }}
          </span>
          {% endif %}
        </div>
        <div class="memory-actions">
          <button class="btn btn-sm btn-outline" onclick="viewMemory('{{ memory.memory_id }}')">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-sm btn-outline btn-danger" onclick="deleteMemory('{{ memory.memory_id }}')">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
  <div class="empty-state">
    <i class="fas fa-brain fa-3x"></i>
    <h3>No Memories Found</h3>
    <p>Memories will appear here as your agents learn and interact.</p>
  </div>
  {% endif %}
</div>

<!-- Memory Details Modal -->
<div class="modal-overlay" id="memory-detail-modal" style="display: none;">
  <div class="modal" style="max-width: 700px;">
    <div class="modal-header">
      <h3><i class="fas fa-brain"></i> Memory Details</h3>
      <button type="button" class="modal-close" onclick="Marvain.hideModal('memory-detail-modal')">&times;</button>
    </div>
    <div class="modal-body" id="memory-detail-content">
      <div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterMemories() {
  const agent = document.getElementById('agent-filter').value;
  const tier = document.getElementById('tier-filter').value;
  const space = document.getElementById('space-filter').value;
  const search = document.getElementById('search-filter').value.toLowerCase();
  
  document.querySelectorAll('.memory-card').forEach(card => {
    const matchAgent = !agent || card.dataset.agent === agent;
    const matchTier = !tier || card.dataset.tier === tier;
    const matchSpace = !space || card.dataset.space === space;
    const matchSearch = !search || card.dataset.content.includes(search);
    card.style.display = matchAgent && matchTier && matchSpace && matchSearch ? '' : 'none';
  });
}

async function viewMemory(memoryId) {
  const content = document.getElementById('memory-detail-content');
  content.innerHTML = '<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
  Marvain.showModal('memory-detail-modal');

  try {
    const response = await fetch(`/api/memories/${memoryId}`);
    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.detail || 'Failed to load memory');
    }
    const memory = await response.json();

    const tierBadge = {
      'episodic': 'info',
      'semantic': 'success',
      'procedural': 'warning'
    }[memory.tier] || 'secondary';

    const participants = memory.participants || [];
    const provenance = memory.provenance || {};
    const retention = memory.retention || {};

    content.innerHTML = `
      <div class="detail-section">
        <h4><i class="fas fa-info-circle"></i> Basic Info</h4>
        <div class="detail-grid">
          <div class="detail-row">
            <span class="detail-label">Memory ID</span>
            <code class="detail-value">${memory.memory_id}</code>
          </div>
          <div class="detail-row">
            <span class="detail-label">Tier</span>
            <span class="badge badge-${tierBadge}">${memory.tier}</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Agent</span>
            <span class="detail-value">${memory.agent_name || memory.agent_id}</span>
          </div>
          ${memory.space_name ? `
          <div class="detail-row">
            <span class="detail-label">Space</span>
            <span class="detail-value">${memory.space_name}</span>
          </div>` : ''}
          <div class="detail-row">
            <span class="detail-label">Created</span>
            <span class="detail-value">${memory.created_at || 'N/A'}</span>
          </div>
        </div>
      </div>

      <div class="detail-section">
        <h4><i class="fas fa-file-alt"></i> Content</h4>
        <pre class="json-display">${memory.content || 'No content'}</pre>
      </div>

      ${participants.length > 0 ? `
      <div class="detail-section">
        <h4><i class="fas fa-users"></i> Participants</h4>
        <div class="participant-list">
          ${participants.map(p => `<span class="badge badge-outline">${p}</span>`).join(' ')}
        </div>
      </div>` : ''}

      ${Object.keys(provenance).length > 0 ? `
      <div class="detail-section">
        <h4><i class="fas fa-history"></i> Provenance</h4>
        <pre class="json-display">${JSON.stringify(provenance, null, 2)}</pre>
      </div>` : ''}

      ${Object.keys(retention).length > 0 ? `
      <div class="detail-section">
        <h4><i class="fas fa-clock"></i> Retention</h4>
        <pre class="json-display">${JSON.stringify(retention, null, 2)}</pre>
      </div>` : ''}
    `;
  } catch (error) {
    content.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i> ${error.message}</div>`;
  }
}

async function deleteMemory(memoryId) {
  if (!confirm('Are you sure you want to delete this memory? This action cannot be undone.')) {
    return;
  }
  
  try {
    Marvain.showLoading('Deleting memory...');
    const response = await fetch(`/api/memories/${memoryId}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.detail || 'Failed to delete memory');
    }
    
    Marvain.hideLoading();
    Marvain.showToast('success', 'Success', 'Memory deleted');
    setTimeout(() => location.reload(), 1000);
  } catch (error) {
    Marvain.hideLoading();
    Marvain.showToast('error', 'Error', error.message);
  }
}
</script>
{% endblock %}

