{% extends "base.html" %}

{% block title %}Memories - Marvain{% endblock %}

{% block content %}
<div class="page-header">
  <div>
    <h1 class="page-title"><i class="fas fa-brain"></i> Memories</h1>
    <p class="text-muted">Browse and manage agent memories</p>
  </div>
</div>

<!-- Filter Bar -->
<div class="filter-bar mb-lg">
  <div class="filter-group">
    <label for="agent-filter">Agent</label>
    <select id="agent-filter" onchange="filterMemories()">
      <option value="">All Agents</option>
      {% for agent in agents %}
      <option value="{{ agent.agent_id }}">{{ agent.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="filter-group">
    <label for="tier-filter">Tier</label>
    <select id="tier-filter" onchange="filterMemories()">
      <option value="">All Tiers</option>
      <option value="episodic">Episodic</option>
      <option value="semantic">Semantic</option>
      <option value="procedural">Procedural</option>
    </select>
  </div>
  <div class="filter-group">
    <label for="space-filter">Space</label>
    <select id="space-filter" onchange="filterMemories()">
      <option value="">All Spaces</option>
      {% for space in spaces %}
      <option value="{{ space.space_id }}">{{ space.name }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="filter-group flex-grow">
    <label for="search-filter">Search</label>
    <input type="text" id="search-filter" placeholder="Search memories..." oninput="filterMemories()">
  </div>
</div>

<!-- Stats Bar -->
<div class="stats-bar mb-lg">
  <div class="stat-item">
    <span class="stat-label">Total</span>
    <span class="stat-value">{{ memories|length }}</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">Episodic</span>
    <span class="stat-value tier-episodic">{{ tier_counts.episodic or 0 }}</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">Semantic</span>
    <span class="stat-value tier-semantic">{{ tier_counts.semantic or 0 }}</span>
  </div>
  <div class="stat-item">
    <span class="stat-label">Procedural</span>
    <span class="stat-value tier-procedural">{{ tier_counts.procedural or 0 }}</span>
  </div>
</div>

<!-- Memories List -->
<div class="memories-list" id="memories-list">
  {% if memories %}
  {% for memory in memories %}
  <div class="memory-card card" data-agent="{{ memory.agent_id }}" data-tier="{{ memory.tier }}" data-space="{{ memory.space_id or '' }}" data-content="{{ memory.content|lower }}">
    <div class="card-body">
      <div class="memory-header">
        <div class="memory-meta">
          <span class="tier-badge tier-{{ memory.tier }}">{{ memory.tier }}</span>
          <span class="text-muted">{{ memory.agent_name }}</span>
          {% if memory.space_name %}
          <span class="text-muted">â€¢ {{ memory.space_name }}</span>
          {% endif %}
        </div>
        <div class="memory-time">{{ memory.created_at_relative or 'Unknown' }}</div>
      </div>
      <div class="memory-content">
        {{ memory.content[:500] }}{% if memory.content|length > 500 %}...{% endif %}
      </div>
      {% if memory.participants %}
      <div class="memory-participants">
        <i class="fas fa-users"></i>
        {% for p in memory.participants[:3] %}
        <span class="participant-badge">{{ p }}</span>
        {% endfor %}
        {% if memory.participants|length > 3 %}
        <span class="participant-badge more">+{{ memory.participants|length - 3 }}</span>
        {% endif %}
      </div>
      {% endif %}
      <div class="memory-footer">
        <div class="memory-provenance">
          {% if memory.provenance_source %}
          <span class="provenance-badge" title="{{ memory.provenance_source }}">
            <i class="fas fa-history"></i> {{ memory.provenance_source[:20] }}
          </span>
          {% endif %}
        </div>
        <div class="memory-actions">
          <button class="btn btn-sm btn-outline" onclick="viewMemory('{{ memory.memory_id }}')">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-sm btn-outline btn-danger" onclick="deleteMemory('{{ memory.memory_id }}')">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
  {% else %}
  <div class="empty-state">
    <i class="fas fa-brain fa-3x"></i>
    <h3>No Memories Found</h3>
    <p>Memories will appear here as your agents learn and interact.</p>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterMemories() {
  const agent = document.getElementById('agent-filter').value;
  const tier = document.getElementById('tier-filter').value;
  const space = document.getElementById('space-filter').value;
  const search = document.getElementById('search-filter').value.toLowerCase();
  
  document.querySelectorAll('.memory-card').forEach(card => {
    const matchAgent = !agent || card.dataset.agent === agent;
    const matchTier = !tier || card.dataset.tier === tier;
    const matchSpace = !space || card.dataset.space === space;
    const matchSearch = !search || card.dataset.content.includes(search);
    card.style.display = matchAgent && matchTier && matchSpace && matchSearch ? '' : 'none';
  });
}

function viewMemory(memoryId) {
  Marvain.showToast('info', 'Coming Soon', 'Memory details view will be available soon.');
}

async function deleteMemory(memoryId) {
  if (!confirm('Are you sure you want to delete this memory? This action cannot be undone.')) {
    return;
  }
  
  try {
    Marvain.showLoading('Deleting memory...');
    const response = await fetch(`/api/memories/${memoryId}`, {
      method: 'DELETE'
    });
    
    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.detail || 'Failed to delete memory');
    }
    
    Marvain.hideLoading();
    Marvain.showToast('success', 'Success', 'Memory deleted');
    setTimeout(() => location.reload(), 1000);
  } catch (error) {
    Marvain.hideLoading();
    Marvain.showToast('error', 'Error', error.message);
  }
}
</script>
{% endblock %}

