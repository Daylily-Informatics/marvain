<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Memories ‚Äî marvain</title>
  <link rel="stylesheet" href="/static/css/panels.css" />
  <style>
    body { font-family: system-ui, -apple-system, Arial, sans-serif; margin: 24px; line-height: 1.35; }
    h1 { font-size: 1.6em; margin-bottom: 0.2em; }
    .sub { color: #444; margin-bottom: 16px; }
    .layout { display: grid; grid-template-columns: 250px 1fr; gap: 20px; margin-top: 20px; }
    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; }
    a { color: inherit; }
    .nav { display: flex; gap: 12px; margin-bottom: 16px; }
    .nav a { padding: 6px 12px; border: 1px solid #ddd; border-radius: 8px; text-decoration: none; }
    .nav a:hover { background: #f5f5f5; }
    .sidebar { position: sticky; top: 20px; }
    .filter-section { margin-bottom: 16px; }
    .filter-section h4 { margin: 0 0 8px 0; font-size: 0.95em; }
    .filter-btn { display: block; width: 100%; text-align: left; padding: 8px 12px; border: 1px solid #eee; border-radius: 6px; background: #fff; cursor: pointer; margin-bottom: 4px; }
    .filter-btn:hover { background: #f5f5f5; }
    .filter-btn.active { background: #e3f2fd; border-color: #90caf9; }
    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
    .stat-card { background: #f8f9fa; border-radius: 8px; padding: 12px; text-align: center; }
    .stat-value { font-size: 1.5em; font-weight: bold; color: #1976d2; }
    .stat-label { font-size: 0.85em; color: #666; }
  </style>
</head>
<body>
  <h1>Memory Explorer</h1>
  <div class="sub">
    Agent: <strong>{{ state.selected_stack or "Custom Agent" }}</strong> |
    Agent ID: <strong>{{ state.selected_agent_id or "(auto)" }}</strong>
  </div>

  <div class="nav">
    <a href="/">‚Üê Home</a>
    <a href="/chat">Chat</a>
    <a href="/speakers">Speakers</a>
  </div>

  {% if not state.selected_endpoint %}
    <div class="card">
      <p>Please select an agent stack first from the <a href="/">home page</a>.</p>
    </div>
  {% else %}
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="statTotal">-</div>
        <div class="stat-label">Total Memories</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statSpeakers">-</div>
        <div class="stat-label">Speakers</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statKinds">-</div>
        <div class="stat-label">Memory Types</div>
      </div>
    </div>

    <div class="layout">
      <div class="sidebar">
        <div class="card">
          <div class="filter-section">
            <h4>Filter by Type</h4>
            <button class="filter-btn active" data-kind="ALL" onclick="setKindFilter('ALL', this)">All Types <span id="count-ALL"></span></button>
            <button class="filter-btn" data-kind="RAW" onclick="setKindFilter('RAW', this)">üí¨ Raw <span id="count-RAW"></span></button>
            <button class="filter-btn" data-kind="FACT" onclick="setKindFilter('FACT', this)">üìã Facts <span id="count-FACT"></span></button>
            <button class="filter-btn" data-kind="PREFERENCE" onclick="setKindFilter('PREFERENCE', this)">‚ù§Ô∏è Preferences <span id="count-PREFERENCE"></span></button>
            <button class="filter-btn" data-kind="RELATIONSHIP" onclick="setKindFilter('RELATIONSHIP', this)">ü§ù Relationships <span id="count-RELATIONSHIP"></span></button>
            <button class="filter-btn" data-kind="AI_INSIGHT" onclick="setKindFilter('AI_INSIGHT', this)">üß† AI Insights <span id="count-AI_INSIGHT"></span></button>
            <button class="filter-btn" data-kind="ACTION" onclick="setKindFilter('ACTION', this)">‚ö° Actions <span id="count-ACTION"></span></button>
            <button class="filter-btn" data-kind="META" onclick="setKindFilter('META', this)">üìå Meta <span id="count-META"></span></button>
          </div>
          <div class="filter-section">
            <h4>Filter by Speaker</h4>
            <select id="speakerFilter" onchange="setSpeakerFilter(this.value)" style="width: 100%; padding: 8px; border-radius: 6px;">
              <option value="">All Speakers</option>
              <option value="__UNKNOWN__">Unknown Speaker (no speaker_id)</option>
            </select>
          </div>
          <div class="filter-section">
            <h4>Search</h4>
            <input type="text" id="searchInput" placeholder="Search text..." 
                   oninput="setSearch(this.value)" style="width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #ddd;" />
          </div>
        </div>
      </div>
      <div class="card">
        <div id="memoryPanelContainer"></div>
      </div>
    </div>
  {% endif %}

  <script src="/static/js/memory-panel.js"></script>
  <script>
    {% if state.selected_endpoint %}
    // Initialize memory panel
    initMemoryPanel('memoryPanelContainer', {
      refreshInterval: 15000,
      limit: 100,
      onMemorySelect: function(memory) {
        showMemoryDetail(memory);
      }
    });

    // Load speakers for filter
    fetch('/api/speakers')
      .then(r => r.json())
      .then(data => {
        const sel = document.getElementById('speakerFilter');
        (data.speakers || []).forEach(s => {
          const opt = document.createElement('option');
          opt.value = s.speaker_id;
          opt.textContent = s.speaker_name || s.speaker_id;
          sel.appendChild(opt);
        });
        updateStats();
      });

    function setKindFilter(kind, btn) {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
      memoryPanel.setKindFilter(kind);
    }

    function setSpeakerFilter(speakerId) {
      // Handle "Unknown Speaker" filter
      if (speakerId === '__UNKNOWN__') {
        memoryPanel.setSpeakerFilter('__UNKNOWN__');
      } else {
        memoryPanel.setSpeakerFilter(speakerId || null);
      }
    }

    function setSearch(term) {
      memoryPanel.setSearch(term);
    }

    // Fetch real statistics from API
    function updateStats() {
      // Get accurate stats using dedicated API endpoints
      Promise.all([
        fetch('/api/memory_stats').then(r => r.json()),
        fetch('/api/speakers').then(r => r.json())
      ]).then(([statsData, speakersData]) => {
        // Update total memories count
        document.getElementById('statTotal').textContent = statsData.total || 0;

        // Update speakers count from actual speakers query
        document.getElementById('statSpeakers').textContent = (speakersData.speakers || []).length;

        // Update memory types count
        document.getElementById('statKinds').textContent = Object.keys(statsData.by_kind || {}).length;

        // Update counts on filter buttons
        const counts = statsData.by_kind || {};
        const allCount = statsData.total || 0;
        document.getElementById('count-ALL').textContent = allCount > 0 ? `(${allCount})` : '';
        ['RAW', 'FACT', 'PREFERENCE', 'RELATIONSHIP', 'AI_INSIGHT', 'ACTION', 'META'].forEach(kind => {
          const el = document.getElementById(`count-${kind}`);
          if (el) el.textContent = counts[kind] ? `(${counts[kind]})` : '';
        });
      }).catch(e => {
        console.error('Failed to update stats:', e);
        // Fallback to basic count
        fetch('/api/memories?limit=500')
          .then(r => r.json())
          .then(data => {
            const mems = data.memories || [];
            document.getElementById('statTotal').textContent = mems.length;
          });
      });
    }

    function showMemoryDetail(memory) {
      const sessionInfo = memory.session_id ? `\nSession: ${memory.session_id}` : '';
      const sourceInfo = memory.meta?.source ? `\nSource: ${memory.meta.source}` : '';
      alert(`Memory Detail:\n\nType: ${memory.kind}\nText: ${memory.text}\nSpeaker: ${memory.speaker_id || 'N/A'}${sessionInfo}${sourceInfo}\nTime: ${memory.ts || 'N/A'}`);
    }

    setInterval(updateStats, 30000);
    {% endif %}
  </script>
</body>
</html>

