<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Speakers ‚Äî marvain</title>
  <link rel="stylesheet" href="/static/css/panels.css" />
  <style>
    body { font-family: system-ui, -apple-system, Arial, sans-serif; margin: 24px; line-height: 1.35; }
    h1 { font-size: 1.6em; margin-bottom: 0.2em; }
    .sub { color: #444; margin-bottom: 16px; }
    .layout { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; margin-top: 20px; }
    @media (max-width: 900px) { .layout { grid-template-columns: 1fr; } }
    .card { border: 1px solid #ddd; border-radius: 10px; padding: 14px; }
    a { color: inherit; }
    .nav { display: flex; gap: 12px; margin-bottom: 16px; }
    .nav a { padding: 6px 12px; border: 1px solid #ddd; border-radius: 8px; text-decoration: none; }
    .nav a:hover { background: #f5f5f5; }
  </style>
</head>
<body>
  <h1>Speaker Management</h1>
  <div class="sub">
    Agent: <strong>{{ state.selected_stack or "Custom Agent" }}</strong> |
    Endpoint: <code>{{ state.selected_endpoint or "(none)" }}</code>
  </div>

  <div class="nav">
    <a href="/">‚Üê Home</a>
    <a href="/chat">Chat</a>
    <a href="/memories">Memories</a>
  </div>

  {% if not state.selected_endpoint %}
    <div class="card">
      <p>Please select an agent stack first from the <a href="/">home page</a>.</p>
    </div>
  {% else %}
    <div class="layout">
      <div class="card">
        <div id="speakerPanelContainer"></div>
      </div>
      <div class="card">
        <h2 style="margin-top: 0;">Speaker Details</h2>
        <div id="speakerDetailsArea">
          <p class="meta">Select a speaker from the list to view their profile and memories.</p>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top: 20px;">
      <h2 style="margin-top: 0;">Quick Actions</h2>
      <div style="display: flex; gap: 12px; flex-wrap: wrap;">
        <button class="btn" onclick="speakerPanel.showEnrollmentModal()">+ Enroll New Speaker</button>
        <button class="btn" onclick="speakerPanel.loadSpeakers()">‚Üª Refresh List</button>
        <button class="btn" onclick="exportSpeakers()">üì• Export All</button>
      </div>
    </div>
  {% endif %}

  <script src="/static/js/speaker-panel.js"></script>
  <script>
    {% if state.selected_endpoint %}
    // Initialize speaker panel
    initSpeakerPanel('speakerPanelContainer', {
      refreshInterval: 30000,
      onSpeakerSelect: function(speaker) {
        showSpeakerDetails(speaker);
      },
      onEnrollmentComplete: function(data) {
        alert('Speaker enrolled successfully!');
      }
    });

    function showSpeakerDetails(speaker) {
      const area = document.getElementById('speakerDetailsArea');
      if (!speaker) {
        area.innerHTML = '<p class="meta">Select a speaker to view details.</p>';
        return;
      }
      
      // Fetch full profile with memories
      fetch(`/api/speakers/${speaker.speaker_id}`)
        .then(r => r.json())
        .then(data => {
          const p = data.profile || speaker;
          const mems = data.memories || [];
          area.innerHTML = `
            <div class="detail-grid" style="margin-bottom: 16px;">
              <div><strong>Name:</strong> ${p.speaker_name || 'Unknown'}</div>
              <div><strong>ID:</strong> <code>${p.speaker_id}</code></div>
              <div><strong>Status:</strong> <span class="badge ${p.enrollment_status}">${p.enrollment_status}</span></div>
              <div><strong>Interactions:</strong> ${p.interaction_count || 0}</div>
              <div><strong>First Seen:</strong> ${p.first_seen ? new Date(p.first_seen).toLocaleDateString() : 'N/A'}</div>
              <div><strong>Last Seen:</strong> ${p.last_seen ? new Date(p.last_seen).toLocaleDateString() : 'N/A'}</div>
            </div>
            ${p.notes ? `<div style="margin-bottom: 16px;"><strong>Notes:</strong> ${p.notes}</div>` : ''}
            <h3>Memories (${mems.length})</h3>
            <div class="memory-list" style="max-height: 300px; overflow-y: auto;">
              ${mems.length === 0 ? '<p class="meta">No memories for this speaker.</p>' :
                mems.map(m => `
                  <div class="memory-item ${(m.kind || '').toLowerCase()}" style="margin-bottom: 8px;">
                    <div class="memory-header">
                      <span class="memory-kind-badge ${(m.kind || '').toLowerCase()}">${m.kind || '?'}</span>
                      <span class="memory-ts">${m.ts ? new Date(m.ts).toLocaleString() : ''}</span>
                    </div>
                    <div class="memory-text">${m.text || ''}</div>
                  </div>
                `).join('')}
            </div>
          `;
        })
        .catch(e => {
          area.innerHTML = `<p style="color: red;">Error loading speaker: ${e}</p>`;
        });
    }

    function exportSpeakers() {
      fetch('/api/speakers')
        .then(r => r.json())
        .then(data => {
          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'speakers_export.json';
          a.click();
        })
        .catch(e => alert('Export failed: ' + e));
    }
    {% endif %}
  </script>
</body>
</html>

