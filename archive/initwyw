#!/usr/bin/env bash
# initwyw - Cross-platform initialization script for Marvain voice agent
# Usage: source initwyw <AWS_PROFILE> <AWS_REGION> [STACK_PREFIX]
#
# Sets AWS_PROFILE/AWS_REGION/AWS_DEFAULT_REGION, AGENT_RESOURCE_STACK_PREFIX,
# activates Python virtual environment, and verifies dependencies.
#
# Supports: macOS, Ubuntu Linux, and other Debian-based systems

set -e

# Color codes for output (works on both macOS and Linux)
if [[ -t 1 ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[0;33m'
    BLUE='\033[0;34m'
    NC='\033[0m' # No Color
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    NC=''
fi

_log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

_log_success() {
    echo -e "${GREEN}[OK]${NC} $1"
}

_log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

_log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Detect OS
_detect_os() {
    local os_type=""
    case "$(uname -s)" in
        Darwin*)    os_type="macos" ;;
        Linux*)
            if [ -f /etc/os-release ]; then
                # shellcheck disable=SC1091
                . /etc/os-release
                case "$ID" in
                    ubuntu|debian|linuxmint|pop) os_type="debian" ;;
                    fedora|rhel|centos|rocky|alma) os_type="redhat" ;;
                    arch|manjaro) os_type="arch" ;;
                    *) os_type="linux" ;;
                esac
            else
                os_type="linux"
            fi
            ;;
        CYGWIN*|MINGW*|MSYS*) os_type="windows" ;;
        *)          os_type="unknown" ;;
    esac
    echo "$os_type"
}

# Check if a command exists
_command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Find Python 3
_find_python() {
    local python_cmd=""
    for cmd in python3.12 python3.11 python3.10 python3 python; do
        if _command_exists "$cmd"; then
            local version
            version=$("$cmd" --version 2>&1 | grep -oE '[0-9]+\.[0-9]+' | head -1)
            local major minor
            major=$(echo "$version" | cut -d. -f1)
            minor=$(echo "$version" | cut -d. -f2)
            if [ "$major" -eq 3 ] && [ "$minor" -ge 9 ]; then
                python_cmd="$cmd"
                break
            fi
        fi
    done
    echo "$python_cmd"
}

# Find the virtual environment
_find_venv() {
    local venv_dir=""
    for dir in .venv venv env .env; do
        if [ -d "$dir" ] && [ -f "$dir/bin/activate" ]; then
            venv_dir="$dir"
            break
        fi
    done
    echo "$venv_dir"
}

# Activate virtual environment
_activate_venv() {
    local venv_dir="$1"
    if [ -n "$venv_dir" ] && [ -f "$venv_dir/bin/activate" ]; then
        # shellcheck disable=SC1091
        source "$venv_dir/bin/activate"
        return 0
    fi
    return 1
}

# Create virtual environment if needed
_create_venv() {
    local python_cmd="$1"
    local venv_dir="${2:-.venv}"

    if [ ! -d "$venv_dir" ]; then
        _log_info "Creating Python virtual environment in $venv_dir..."
        "$python_cmd" -m venv "$venv_dir"
    fi

    if _activate_venv "$venv_dir"; then
        _log_success "Activated virtual environment: $venv_dir"
        return 0
    fi
    return 1
}

# Install dependencies if requirements.txt exists
_install_deps() {
    if [ -f "requirements.txt" ]; then
        _log_info "Checking Python dependencies..."
        pip install -q --upgrade pip
        pip install -q -r requirements.txt
        _log_success "Python dependencies installed"
    fi
}

# Verify AWS CLI is configured
_verify_aws() {
    local profile="$1"
    local region="$2"

    if ! _command_exists aws; then
        _log_error "AWS CLI not found. Please install it first."
        _log_info "  macOS: brew install awscli"
        _log_info "  Ubuntu: sudo apt-get install awscli"
        return 1
    fi

    # Test credentials
    if ! AWS_PROFILE="$profile" AWS_REGION="$region" aws sts get-caller-identity >/dev/null 2>&1; then
        _log_warn "AWS credentials may not be configured correctly for profile '$profile'"
        _log_info "Run: aws configure --profile $profile"
    else
        local identity
        identity=$(AWS_PROFILE="$profile" AWS_REGION="$region" aws sts get-caller-identity --query 'Arn' --output text 2>/dev/null)
        _log_success "AWS identity: $identity"
    fi
    return 0
}

# Verify SAM CLI is available
_verify_sam() {
    if ! _command_exists sam; then
        _log_warn "SAM CLI not found. Required for deployments."
        _log_info "  Install: pip install aws-sam-cli"
        _log_info "  Or: brew install aws-sam-cli (macOS)"
        return 1
    fi
    local sam_version
    sam_version=$(sam --version 2>/dev/null | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
    _log_success "SAM CLI version: $sam_version"
    return 0
}

# Check for platform-specific dependencies
_check_platform_deps() {
    local os_type="$1"
    local missing_deps=()

    case "$os_type" in
        macos)
            # Check for Homebrew (optional but useful)
            if ! _command_exists brew; then
                _log_info "Homebrew not installed. Some features may require manual setup."
            fi

            # Check for audio dependencies (for voice features)
            if ! _command_exists ffmpeg; then
                missing_deps+=("ffmpeg (brew install ffmpeg)")
            fi
            ;;
        debian)
            # Check for essential packages
            if ! _command_exists ffmpeg; then
                missing_deps+=("ffmpeg (sudo apt-get install ffmpeg)")
            fi
            if ! _command_exists python3-venv 2>/dev/null; then
                if ! dpkg -l python3-venv >/dev/null 2>&1; then
                    missing_deps+=("python3-venv (sudo apt-get install python3-venv)")
                fi
            fi
            ;;
        redhat)
            if ! _command_exists ffmpeg; then
                missing_deps+=("ffmpeg (sudo dnf install ffmpeg)")
            fi
            ;;
    esac

    if [ ${#missing_deps[@]} -gt 0 ]; then
        _log_warn "Optional dependencies not found:"
        for dep in "${missing_deps[@]}"; do
            echo "  - $dep"
        done
    fi
}

# Export environment variables for scripts
_export_env() {
    export MARVAIN_ROOT
    MARVAIN_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    export MARVAIN_OS
    MARVAIN_OS="$(_detect_os)"
}

# Main initialization
_main() {
    # Ensure script is sourced
    if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
        _log_error "This script must be sourced, not executed."
        echo "Usage: source initwyw <AWS_PROFILE> <AWS_REGION> [STACK_PREFIX]"
        exit 1
    fi

    if [ "$#" -lt 2 ]; then
        echo "Usage: source initwyw <AWS_PROFILE> <AWS_REGION> [STACK_PREFIX]"
        echo ""
        echo "Arguments:"
        echo "  AWS_PROFILE    - AWS CLI profile name"
        echo "  AWS_REGION     - AWS region (e.g., us-east-1)"
        echo "  STACK_PREFIX   - CloudFormation stack prefix (default: marai)"
        echo ""
        echo "Example:"
        echo "  source initwyw default us-east-1 myagent"
        return 1
    fi

    local aws_profile="$1"
    local aws_region="$2"
    local stack_prefix="${3:-marai}"

    echo ""
    _log_info "Initializing Marvain voice agent environment..."
    echo ""

    # Detect OS
    local os_type
    os_type="$(_detect_os)"
    _log_info "Detected OS: $os_type"

    # Export environment
    _export_env

    # Set AWS environment
    export AWS_PROFILE="$aws_profile"
    export AWS_REGION="$aws_region"
    export AWS_DEFAULT_REGION="$aws_region"
    export AGENT_RESOURCE_STACK_PREFIX="$stack_prefix"

    # Find and activate Python
    local python_cmd
    python_cmd="$(_find_python)"
    if [ -z "$python_cmd" ]; then
        _log_error "Python 3.9+ not found. Please install Python."
        return 1
    fi
    _log_success "Found Python: $python_cmd ($($python_cmd --version 2>&1))"

    # Find or create virtual environment
    local venv_dir
    venv_dir="$(_find_venv)"
    if [ -n "$venv_dir" ]; then
        if _activate_venv "$venv_dir"; then
            _log_success "Activated existing virtual environment: $venv_dir"
        fi
    else
        _create_venv "$python_cmd" ".venv"
    fi

    # Verify AWS setup
    _verify_aws "$aws_profile" "$aws_region" || true

    # Verify SAM CLI
    _verify_sam || true

    # Check platform dependencies
    _check_platform_deps "$os_type"

    echo ""
    _log_success "Environment initialized!"
    echo ""
    echo "  AWS_PROFILE=$AWS_PROFILE"
    echo "  AWS_REGION=$AWS_REGION"
    echo "  AGENT_RESOURCE_STACK_PREFIX=$AGENT_RESOURCE_STACK_PREFIX"
    echo "  MARVAIN_ROOT=$MARVAIN_ROOT"
    echo "  MARVAIN_OS=$MARVAIN_OS"
    echo ""
    _log_info "Run 'python -m uvicorn client.gui:app --reload' to start the GUI"
    echo ""

    return 0
}

# Run main function with all arguments
_main "$@"
